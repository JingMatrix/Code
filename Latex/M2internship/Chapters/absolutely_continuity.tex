%! TEX root = ../barycenter.tex
\YYCleverefInput{/var/tmp/latex/barycenter.sed}
\section{Uniqueness of Barycenter in Wasserstein spaces}
% \subsection{Uniqueness of barycenter measure}

We start with a description \cite[Theorem 10.41]{villani2008optimal}
of optimal mass transport on Riemannian manifold.
\begin{thm}[Uniqueness of optimal transport map for the square distance]
	\label{thm:uniquness_monge_problem_manifold}
	Let \( M \) be a Riemannian manifold, and \( c ( x , y ) = \frac{1}{2} d ( x , y ) ^ { 2 } \).
	Let \( \mu , \nu \) be two probability measures on \( M \), such that the optimal cost
	between \( \mu \) and \( \nu \) is finite.
	If \( \mu \) is absolutely continuous (with respect to volume measure $\operatorname{Vol}$ on $M$),
	then the mass transport
	problem between \( \mu \) and \( \nu \) admits a unique optimal transport plan, and it
	has the form \( \diff \pi ( x , y ) = \diff \mu ( x ) \delta [ y = T ( x ) ] \),
	or equivalently \[ \pi = ( \mathrm { Id } \times T )_{\#} \mu , \]
	where \( T \) is uniquely determined, \( \mu \)-almost everywhere,
	by the requirements that \( T_{\#} \mu = \nu \).
\end{thm}

The map \( T \) may be referred as
the optimal (mass) transport map pushing \( \mu \) to \( v \).
% Recall that in \Cref{thm:optimal_transport_manifold} we gave a description of $T$
% as $\exp_x(- \nabla \phi(x))$ when both $\mu$ and $\nu$ have compact supports.
With the help of this theorem, we are ready to prove
\begin{prop}
	\label{prop:uniquness_barycenter_Wasserstein}
	Given a measure $\mathbb{P} \in \mathcal{W}_2(\mathcal{W}_2(M))$,
	assume $\mathbb{P}$ gives mass to the set of absolutely continuous measures $P_{ac}(M) \subset \mathcal{W}_2(M)$,
	i.e.,	$\mathbb{P}(P_{ac}(M)) > 0 $.
	Then $\mathbb{P}$ has a unique barycenter in $\mathcal{W}_2(M)$, which is a probability measure on $M$.
\end{prop}

\begin{rmk}
	$P_{ac}(M)$ is a Borel measurable subset of $(\mathcal{W}_2(M), W_2)$,
	see \cite[Proposition 2.1]{KIM2017640} for a proof.
\end{rmk}

\begin{proof}
	Note that any convex combination of elements the in space $\mathcal{W}_2(\mathcal{W}_2(M))$ is still inside it.
	The squared Wasserstein distance function $W_2(\mu, \cdot)^2$ is convex by definition of optimal plan,
	for $0 \leq \lambda_1, \lambda_2 \leq 1, \gamma_1 + \gamma_2 =1 $ and $ \nu_1,\nu_2 \in \mathcal{W}_2(M)$,
	\begin{equation}
		\label{equa:convexity_Wassersetein_distance}
		W_2(\mu, \lambda_1 \nu_2 + \lambda_2 \nu_2)^2 \leq
		\lambda_1 W_2(\mu, \nu_1)^2 + \lambda_2 W_2(\mu, \nu_2)^2.
	\end{equation}

	And when $\mu \in \mathcal{W}_2(M)$ is absolutely continuous,
	we claim that inequality \cref{equa:convexity_Wassersetein_distance} becomes an equality only when
	$\lambda_1=0$ or $\lambda_2=0$,
	i.e.,
	convexity above becomes strict convexity.
	To prove this claim,
	according to \Cref{thm:uniquness_monge_problem_manifold} we write
	$\gamma_1 : = (\operatorname{Id}  \times T_1)_{\#}\mu$ the optimal plan from $\mu$ to $\nu_1$ and
	$\gamma_2 : = (\operatorname{Id}  \times T_2)_{\#}\mu$ the optimal plan from $\mu$ to $\nu_2$.

	We assume that there exists a $\gamma := \lambda_1 \gamma_1 + \lambda_2 \gamma_2$
	for some $\gamma_1, \gamma_2$ that turns
	\cref{equa:convexity_Wassersetein_distance} into an equality,
	we then have
	\begin{align*}
		\lambda_1 W_2(\mu, \nu_1)^2 + \lambda_2 W_2(\mu, \nu_2)^2
		 & = W_2(\mu, \lambda_1 \nu_2 + \lambda_2 \nu_2)^2             \\
		 & \leq \int_{M \times M} d(x,y)^2 \diff \gamma(x,y)           \\
		 & =	\lambda_1 W_2(\mu, \nu_1)^2 + \lambda_2 W_2(\mu, \nu_2)^2.
	\end{align*}
	Then $\gamma$ is an optimal plan from $ \mu$ to $\lambda_1 \nu_1 + \lambda_2 \nu_2$,
	but it cannot be induced by a map $T$ unless $\lambda_1 =0$ or $\lambda_2 =0$.

	After integrating \cref{equa:convexity_Wassersetein_distance} with respect to $\mathbb{P} \in \mathcal{W}_2(\mathcal{W}_2(M))$,
	we get a convex function
	\[\int_{\mathcal{W}_2(M)} W_2(\mu, \cdot)^2 \diff \mathbb{P}(\mu),\]
	which is strictly convex if $\mathbb{P}$ gives mass to $P_{ac}(M)$, the set of absolutely continuous measures.
	Hence, the barycenter of $\mathbb{P}$ is unique.
\end{proof}

\section{Absolute continuity of barycenter for measures with finite support}

\label{section:absolute_continuity_finite_support}
Recall that in \Cref{thm:barycenter_finite_support_measure},
% we used consistency to prove existence of barycenter in the Wasserstein space
% $\mathcal{W}_p(E)$ over a proper space $E$.
we show the existence of barycenter of measure $\sum_{i=1}^{n} \lambda_i \delta_{\mu_i}$ on $\mathcal{W}_p(E)$;
the barycenter we construct is $B_{\#}\boldsymbol{\gamma} \in \mathcal{W}_p(E)$,
where $B$ is a measurable function from $n$ points $x_i \in E$ to a barycenter of
measure $\sum_{i=1}^{n} \lambda_i \delta_{x_i}$ on $E$
and $\boldsymbol{\gamma}$ is an optimal transport plan
with marginals $\mu_i$ with respect to the continuous cost function $f$.

In this section, we shall first show that
the barycenter of $\sum_{i=1}^n \lambda_i \delta_{\mu_i}$
is unique if some $\mu_i$
is absolutely continuous (with respect to volume measure on the manifold $M$)
and other measures are discrete.
All main ideas in the proofs come from \cite{KIM2017640}.
% we basically re-write their proof in the following sections.
% We start with measure
% $\sum_{j}^{n} \lambda_{j} \delta_{\mu_j}$ on $\mathcal{W}_{2}(M)$.
% for $M$ a complete Riemannian manifold.
To use results and notation in \Cref{section:barycenter_manifold},
we fix $i = 1$ there.
Assume from now on \textcolor{cyan}{
	$ \lambda_1 \neq 0$ and that $\mu_1$ is absolutely continuous and
	concentrated in a pre-compact open set $ \mathcal{X} \subset M $
}.
Recall that we could define $f_1 \in \mathcal{I}^c( \widebar{ \mathcal{X} }, Y)$
as a $c$-concave function.
The barycenter measure $\widebar{\mu}$ of $\sum_{i}^{n} \lambda_{i} \delta_{\mu_i}$ is unique by \Cref{prop:uniquness_barycenter_Wasserstein}.
% because this measure gives mass to element in $P_{ac}(M)$.
% \subsubsection{One measure absolutely continous and others Dirac}
% We firstly consider the case when \textcolor{cyan}
\subsection{\texorpdfstring{$\mu_i = \delta_{x_i}, i \geq 2$}{µ\_i = δ\_\{x\_i\}, i ≥ 2} are Dirac measures}
\label{section:dirac_measures}
In this case, there is only one measure $\boldsymbol{\gamma}$ with marginals $\mu_i$.
As a consequence, $\exp(-\nabla f_1 / \lambda_1)$ pushes $\mu_1$ to $\widebar{\mu}$.
As a left inverse to $\exp(-\nabla f_1/\lambda_1)$,
\(\exp(-\nabla g_1)\) pushes $\widebar{\mu}$ to $\mu_1$.
Then $\widebar{\mu}$ is concentrated on the union of barycenters,
i.e., the compact set $Y$ by the definition of $Y$ in \Cref{section:barycenter_manifold}.
% We shall show soon $\exp(- \nabla g_1)$ could be almost everywhere Lipschitz
% with respect to volume measure if $M$ has lower bound for Ricci curvature.
% Now assume that is the case.
% This long inequality implies that any $w$ in the equality
% $c(x_i, w) = f_i / \lambda_i (x_i) + (f_i / \lambda_i)^c(w)$ must be a barycenter of $\sum_{i=1}^{n} \lambda_i \delta_{x_i}$.
% Moreover, we have following equality holds whenever one of gradients exits,
% \[\exp(-\nabla g_i) = \exp(-\nabla (f_i / \lambda_i)^c) = \exp^{-1}(-\nabla f_i / \lambda_i).\]
% Note cut-locus are excluded from consideration in above equality,
% and as a corollary $\nabla g_i = \nabla (f_i / \lambda_i)^c$.
% Therefore, two locally Lipschitz function $g_i$ and $f_i /\lambda_i$ coincide almost everywhere.
% If follows $g_i=f_i /\lambda_i$ on $M$.
% We discuss following in the sense of $\widebar{\mu}$ almost everywhere.
% The function $g_1$ is by definition just a sum of squared distance functions.
% Now we aim to find out when $ \exp(- \nabla g_1 )$ is a Lipschitz function.
% with Lipschitz constant depending only on $M$ and $\lambda_1$.
% As $M$ is compact, though tangent bundle $TM$ is not compact, local Lipschitz plus bounded diameter of $M$ implies global Lipschitz of $\exp$.
% Function $g_1$ has hessian upper bound by \Cref{prop:differentiate_optimal_transport},
% here we treat it as an infimal convolution over a fixed sigleton set $\{x_1\}$.
% Note that from $ \nabla g_1 = \nabla (f_1 / \lambda_1)^c$,
% $g_1$ and $(f_1 / \lambda_1)^c$ have the same hessian.
% Assume squared distance function has upper bound,
% then  $g_1$ has hessian upper bound as a $c$-conjugate function;
% function $g_1$ has hessian lower bound as a negative linear combination of square distance function.
% We then have
% \begin{equation}
% 	\label{equa:hessian_bound_f}
% 	-\frac{1-\lambda_1}{\lambda_1} H \leq \nabla^2 g_1, \qquad \nabla^2 (f_1 / \lambda_1)^c \leq H,
% \end{equation}
% where we denote by $H$ a possible bound from above for the hessian of square distance funtion.
% Recall that $H$ is bounded from above.
% Squared distance function $c$ has bounded Hessian from above.
% Hence $ \| \nabla^2 g \|$ is bounded from above by taking the second derivative of definition and also applying minimallity of cost at barycenter.
% Hence, we need two properties to have Lipschitzness of $\exp(-\nabla (f_1 / \lambda_1)^c)$:
% \begin{itemize}
% 	\item $ \exp $ is Lipschitz on the domain we are interested in.
% 	      % This would be the case when we are in the support of a compact supported function.
% 	      For example, in a compact domain.
% 	\item The hessian of square distance function has upper bound $H$.
% 	      This is the case when we have lower bound of sectional curvature.
% \end{itemize}
% We always take the second condition in following discussion.
% When $x_1$ runs through a bounded set,
% all possible barycenters are included in a bounded set.
% Hence $\widebar{\mu}$ has compact support.
% As we actually only consider measures with compact support, the first assumption is fullfilled as well.
% because $br$ pushes $\mu_1$ to $\widebar{\mu}$ by construction of $\widebar{\mu}$.
For $y \in Y$, $g_1$ is smooth by \Cref{lem:barycenter_out_of_cut_locus},
so $\exp( - \nabla g_1)$ is Lipschitz in a small open ball with center $y$.
Choose a finite cover for $Y$ from these balls,
and denote by $C$ \underline{a global Lipschitz constant} of the map \(\exp(-\nabla g_1)\) on $Y$.
Absolute continuity of $\mu_1$ means that given any $\epsilon > 0$,
we can always find a $\delta > 0$ such that $ \operatorname{Vol}(E) < \delta \implies \mu_1(E) < \epsilon$.
On the other hand, we have for any measurable set $E$,
$\nabla g_1$ is well-defined on $E \cap Y$ and
$\operatorname{Vol}( \exp(- \nabla g_1 )( E \cap Y )) < C^n \operatorname{Vol}(E \cap Y)$
since volume measure is in fact a Hausdorff measure,
see \cite[Propositions 12.6 and 12.12]{TaylorMichaelEugene1946} for details.
Finally,
\begin{equation}
	\label{equa:absolutely_continuity_estimation}
	\operatorname{Vol}(E) < \delta / C^n \implies \widebar{\mu}(E)
	=\mu_1(\exp(-\nabla g_1)(E \cap Y)) < \epsilon.
\end{equation}
Therefore, $\widebar{\mu}$ is absolutely continuous.
% Here the Lipschitz constant $C$ depends on the support of $\mu_1$.
% Since $\exp(-\nabla(f_1 / \lambda_1)^c) = \exp(-\nabla g_1) $ is continous for Vol-a.e. $x_1$
% (outside of cut-locus of $x_j, j \ne 1$),
% we deduce from absolute continuity of $\widebar{\mu}$ and compact support of $\mu_1$ that
% $\widebar{\mu}$ has also compact support.
% We have in general that the $c$-conjugate of $f_1 / \lambda_1$ satisfies
% $(f_1 / \lambda_1)^c = g_1^{cc} \geq g_1$,
% and thus $c(w, x_1) \geq (f_1 / \lambda_1)^c(w) + f_1/\lambda_1 (x_1) \geq g_1(w) + f_1/\lambda_1 (x_1)$.
% When $w$ is barycenter for some $x_1$,
% we have $g_1(w) = (f_1 / \lambda_1)^c(w)$.
% Hence, from the definition of $\widebar{\mu}$ we have
% $g_1 = (f_1 /\lambda_1)^c$ for $\widebar{\mu}$ alomost everywhere.
% And we have by minimallity that,
% $x_1 = \exp_w(- \nabla g_1(w)) = \exp_w(- \nabla (f_1 / \lambda_1)^c(w))$ once gradients exist.
% Therefore, we have $\nabla g_1 = \nabla (f_1 / \lambda_1)^c$ for volume measure almost everywhere.
% \begin{rmk}
% 	Once after we prove that $\widebar{\mu}$ is indeed absolutely continous.
% 	$\nabla g$ is invertable and $br(x_1) = \exp_{x_1} \nabla g^c(x_1)$.
% 	It is not surprised that
% 	\[
% g^c(x_1) = -c(x_1 ,z) - \frac{1}{\lambda_1} \sum_{i=2}^{n} \lambda_i\, c(x_i, z) =
% - \frac{1}{2 \lambda_1} W^2( \sum_{i=1}^n \lambda_i \delta_{x_i}, M),
% - f_1/\lambda_i.
% \]
% we can then take derivative with respect to $x_1$.
% \end{rmk}
% \subsubsection{To a more general case by conditional probability}
% \label{discussion_conditional_prob}
% To attack general case when \textcolor{cyan}{
\subsection{\texorpdfstring{$\mu_i, i \geq 2$}{µ\_i, i ≥ 2} are discrete measures}
\label{section:discrete_measures}
To proceed with this slightly more general case,
we should use the notion of regular conditional measure \cite[Definition 10.4.2]{Bogachev2007}.
% see it also on \href{https://en.wikipedia.org/wiki/Regular_conditional_probability}{Wikipedia}.

\begin{defn}
	\label{defn:regular_conditional_measure}
	Let $M$ be a complete Riemannian manifold and
	let $\gamma$ a be probability measure on $M^n$.
	Denote by $x^\prime = (x_2, \ldots, x_n) \in M^{n-1}$ the last $n-1$ coordinate components
	of a point $x = (x_1, x_2, \ldots, x_n) \in M^n$ and
	denote by $\pi$ the push-forward measure on $M^{n-1}$ from $\gamma$ by
	the projection $x = (x_1, x^\prime) \mapsto x^\prime$.

	We call $\gamma(\diff x , x^\prime)$ 
	a regular conditional measure if
	% the following equation
	% means that:
	\begin{enumerate}
		\item for $x^\prime \in E^{n-1}$, $\gamma(\cdot , x^\prime)$ is a measure on $M^n$,
		\item for $\pi$ almost everywhere $x^\prime$, $\gamma(\cdot, x^\prime)$ is a probability measure
		      concentrated on $M \times \{x^\prime\}$,
		\item for any Borel set $R \subset M^n$ , the function $ x^\prime \mapsto \gamma(R , x^\prime)$ is measurable and
		\item for any Borel set $S \subset M^{n-1}$,
		      $\gamma(R \cap M \times S) = \int_{S} \gamma( R , x^\prime) \diff \pi(x^\prime)$.
	\end{enumerate}
	Usually we write
	$ \label{equa:conditional_measure}
		\diff \gamma(x) = \gamma(\diff x , x^\prime)\, \diff \pi(x^\prime) $.
\end{defn}

The regular conditional measure $\gamma(\diff x , x^\prime)$ always exists \cite[Corollary 10.4.10]{Bogachev2007},
and it coincides with the disintegration \cite[Section 10.6]{Bogachev2007} of $\gamma$
with respect to the projection $(x_1, x^\prime) \mapsto x^\prime$.
% Generally speaking, computation of $\gamma(\cdot , x^\prime)$ is only possible when
Heuristically, $\gamma(\diff x , x^\prime) = \diff \gamma(x) / \diff \pi (x^\prime)$ is a generalization of
the classic conditional probability formula $P(A \mid B) = P(A B) / P(B)$.
\begin{example}[Calculation of regular conditional measure]
	\label{example:regular_conditional_measure}
	For illustration, we use the notation in \Cref{defn:regular_conditional_measure} and
	calculate $\gamma(\cdot , x^\prime)$ in two cases,
	\begin{enumerate}
		\item $\pi$ is has finite support.
		      % This is equivalent to that all $\mu_i, i \geq 2$ are discrete measures.
		      For $x^\prime$ such that $\pi(\{x^\prime\}) >0$, by setting $S=\{x^\prime\}$, we get
		      \[
			      \gamma(R , x^\prime) =
			      \frac{
				      \mathbbm{1}_{M \times \{x^\prime\}}
				      \gamma(R)
			      }{\pi(\{x^\prime\})} =
			      \frac{\gamma(R \cap M \times \{x^\prime\})
			      }{\pi(\{x^\prime\})}.
		      \]
		\item $\gamma$ has a density function $f: M^n \rightarrow \mathbb{R} $.
		      For $x^\prime$ such that
		      $\pi (\{ x^\prime\}) > 0 $,
		      a direct application of Fubini's theorem gives that
		      \[
			      \gamma(R , x^\prime) =
			      \int_{(x_1, x^\prime) \in R}
			      \frac{f(x_1, x^\prime)} {\pi(\{x^\prime\})}
			      \diff \operatorname{Vol}(x_1)=
			      \int_{(x_1, x^\prime) \in R} \frac{ f(x_1, x^\prime)} {\int_{M} f(x_1, x^\prime) \diff \operatorname{Vol}(x_1)}\diff \operatorname{Vol}(x_1).
		      \]
	\end{enumerate}
	In both cases, we set $\gamma(R, x^\prime)=0$ when $\pi(\{x^\prime\})=0$.
\end{example}

In our situation, we set $\gamma$ an optimal transport plan with margins $\mu_i$.
It follows that as a function on Borel subsets of $M$,
\begin{equation}
	\label{equa:push_forward_conditional_measure}
	\widebar{\mu}(\cdot) = B_{\#} \gamma (\cdot)= \int_{M^{n-1}} B_{\#} \gamma(\cdot , x^\prime)\, \diff \pi(x^\prime).
\end{equation}
% Note in both cases, $\gamma(\cdot , x^\prime)$
% has absolutely continous push-forward measure
% $\mu_1^{x^\prime} := \text{proj}^1_{\#}\gamma(\cdot , x^\prime)$
% to the first coordinate.
If we show that for $\pi$ almost everywhere $x^\prime$, the measure
$B_{\#} \gamma(\cdot , x^\prime)$ is absolutely continuous,
then we could infer from \cref{equa:push_forward_conditional_measure} above that
$\widebar{\mu}(E)=0$ for any $\text{Vol}$-negligible set $E \subset M$ by integration.
That is to say, the measure $\widebar{\mu}$ is absolutely continuous
if $B_{\#}\gamma(\cdot, x^\prime)$ is so.

% But only in the first case that the measures $\gamma(\cdot , x^\prime) \leq \pi(x^\prime) \, \gamma(\cdot)$
% re controlled by $\gamma$.
% Or we hope $f$ has positive lower bound,
% for example \textcolor{cyan}{continous and strictly positive}, like volume measure.
% In the case $\mu_1=\operatorname{Vol}$? Every point in $\text{spt}\mu_1$ runs over all $\times_i \text{spt}\mu_i$.
% \textcolor{red}{Unfortunately, this control is required to apply conditioning optimal plan.}
% One may consider the case when at least one marginal is discrete,
% but no absolute continuity can be derived without barycenter push-forward.
% It is true that we have $\gamma$ is an optimal plan for all its marginals
% \[
% 	B_{\#} \gamma              = \widebar{\mu} \text{ and }
% 	\text{proj}^1_{\#} \gamma  = \mu_1,
% \]
Note that only in the first case of \Cref{example:regular_conditional_measure},
we are sure that $\pi(\{x^\prime\}) \gamma(R, x^\prime) \leq \gamma(R)$.
% In the two cases we have calculated for $\gamma(\cdot, x^\prime)$,
This means that when $\mu_i$ are discrete measures,
\Cref{thm:restriction_optimal_plan} is applicable, which says that
restriction of (multi-marginal) optimal transport plan is still optimal.
Therefore, $\gamma(\cdot , x^\prime)$ is an optimal transport plan of its marginals.
% \textcolor{cyan}{in the case of discrete measure}.
From \Cref{section:dirac_measures}, we know that $B_{\#}\gamma(\cdot, x^\prime)$
is absolutely continuous.
This proves that $\bar{\mu}$ is absolutely continuous.

% \[
% 	\widebar{\mu}(E)
% =\int_{M^{n-1}}
% \frac{ \mu_1( br^{-1}(E) \cap A_{x^\prime} )}{\mu_1(A_{x^\prime})}
% \diff \pi(x^\prime)
% =\int_{M^{n-1}}
% \widebar{\mu}^{x^\prime}(E)
% \diff \pi(x^\prime)
% \leq \int_{M^{n-1}} C\,\mu_1^{\prime}(E) \diff \pi(x^\prime) \leq C\, \mu_1(E).
% = 0.
% \]
\begin{rmk}
	\label{rmk:global_Lipschitz_constant}
	Note that the Lipschitz constant $C$ of $\exp(-\nabla g_1)$
	in \cref{equa:absolutely_continuity_estimation}
	not only depends on the compact supports of $\widebar{\mu}$
	but also depends on $x^\prime$
	since in the definition of $g_1(x):=- \frac{1}{\lambda_1}\sum_{j=2}^n \lambda_j d(x, x_j)^2$
	we already fix an $x^\prime = (x_2, \ldots, x_n)$.

	Denote by $C$ a global Lipschitz constant for all $x^\prime$ (finitely many) in the support of $\pi$,
	i.e., $\operatorname{Vol}(E) < \delta /C^n \implies B_{\#} \gamma(E , x^\prime) < \epsilon$
	for those $x^\prime$.
	By \cref{equa:push_forward_conditional_measure}, we get again that
	\[
		\operatorname{Vol}(E) < \delta / C^n \implies \widebar{\mu}(E)
		= \int_{M^{n-1}} B_{\#}\gamma(E , x^\prime) \diff \pi(x^\prime) < \epsilon.
	\]
	However, if $x^\prime = (x_2, \ldots, x_n)$ under consideration varies infinitely
	in $x_j$ for $2 \leq j \leq n$,
	we need more complicated tools to find such a global Lipschitz constant $C$;
	see the proof of \Cref{thm:absolute_continuity_discrete}.
\end{rmk}
