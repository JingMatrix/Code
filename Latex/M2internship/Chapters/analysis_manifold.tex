%! TEX root = ../barycenter.tex
\YYCleverefInput{/var/tmp/latex/barycenter.sed}
\chapter{Wasserstein space over a complete Riemannian manifold}

For the study in the case when $E$ is a complete Riemannian manifold $M$,
we set $p = 2$.
Hence, in this chapter we talk about the only Wasserstein space $(\mathcal{W}_2(M), W_2)$.
% Let us recall some notations in \Cref{thm:barycenter_finite_support_measure}.
% There is a measurable function $B$ mapping $n$ points $x_i \in E$ to a barycenter of $\sum_{i=1}^{n} \lambda_i \delta_{x_i}$.
% For the convenience of later
% \[f(\boldsymbol{x}) :=W_p(\sum_{i=1}^n \lambda_i \delta_{\mu_i}, E)^p =\min_{x \in E} \sum_{i=1}^n \lambda_i d(x, x_i)^p\]
% is continuous.
We introduce some preliminary propositions for analysis on complete Riemannian manifolds,
which are found by McCann in \cite{mccann2001polar} and then extended in \cite{cordero2001riemannian}.
% To begin with, we shall establish 
They implies some fine properties of two functions $f$ and $B$ in the context of \Cref{thm:barycenter_finite_support_measure}.
% As an infimum involution, $f$ is locally Lipschitz;
% while $B$, not necessarily continuous, shares similar properties as optimal transport maps
% and we should talk about their differentiability only with respect to some reference measure.
% As we shall see later from \cref{equa:formula_barycenter},
% both optimal transport map $T$ in \Cref{thm:uniquness_monge_problem_manifold} and
% the barycenter map $B$
% has the form $\exp( - \nabla h)$ for some $c$-concave
% function $h$ that is differentiable almost everywhere with respect to the volume measure on $M$.
% \section{Details for analysis on manifolds}
\section{\texorpdfstring{$c$}{c}-concave functions}

Most content in this section is a copy-paste from \cite{cordero2001riemannian},
detailed proofs and references are given there.
From now on, $M$ is always a complete Riemannian manifold.
% But $ \nabla h$ is not defined everywhere.
% And even for compact manifold $M$,
% $\exp( - \nabla h)$ as an optimal transport map could be discontinuous.
% A proper definition of the differential $\diff \exp(- \nabla h)$,
% of course only possible almost everywhere,
% is the main goal of this section.

% \subsection{Differentiate squared distance function}


Both $f$ and $B$, and even optimal transport plan are related to so-called $c$-concave functions.
For $x,y \in M$, we define a function $c(x,y): = \frac{1}{2} d(x,y)^2$ as the half of distance between $x$ and $y$.

\begin{defn} [$c$-transforms and the subset \( \mathcal { I } ^ { c } ( X , Y ) \) of \( c \)-concave functions]
	Let \( X \) and \( Y \) be two compact subsets of \( M \).
	The set \( \mathcal{I} ^ { c } ( X , Y ) \) of \( c \)-concave functions (relative to \( X \) and \( Y \)) is
	the set of functions \( \phi \) : \( X \rightarrow \mathbb { R } \cup \{ - \infty \} \) not identically \( - \infty \),
	for which there exists a function \( \psi : Y \rightarrow \mathbb { R } \cup \{ - \infty \} \) such that
	\begin{equation}
		\label{defn:c_transform}
		\phi ( x ) = \inf _ { y \in Y } c ( x , y ) - \psi ( y ) \quad \forall x \in X.
	\end{equation}
	We refer to \( \phi \) as the \( c \)-transform of \( \psi \) and abbreviate \cref{defn:c_transform}
	by writing \( \phi = \psi ^ { c } \).
	Similarly, given \( \phi \in \mathcal{I} ^ { c } ( X , Y ) \),
	we define its \( c \)-transform \( \phi ^ { c } \in \mathcal{I} ^ { c } ( Y , X ) \) by
	\begin{equation}
		\label{equa:c_transform_of_c_conjugate}
		\phi ^ { c } ( y ) : = \inf _ { x \in X } c ( x , y ) - \phi ( x ) \quad \forall y \in Y.
	\end{equation}
\end{defn}

We hope no confusion results from the tacit dependence of
these transformations on the domain of the function being transformed.
For \( \phi \in \) \( \mathcal { I } ^ { c } ( X , Y ) \),
it follows easily from \cref{equa:c_transform_of_c_conjugate} as in Rachev and RÃ¼schendorf
\cite[Section 3.3]{Rachev1998} that
\[ \phi ( x ) = \inf _ { y \in Y } c ( x , y ) - \phi ^ { c } ( y ) \quad \forall x \in X \]
which we abbreviate by writing \( \phi ^ { c c } = \phi \), suppressing the domains of definition once more.
As in \cite{mccann2001polar}, Lipschitz continuity of \( \phi ^ { c } \) follows merely from
compactness of \( X \) and the locally Lipschitzian character of \( c ( x , y ) \),
regardless of whether or not \( \phi : X \rightarrow \mathbb { R } \cup \{ - \infty \} \) is continuous.
Thus, it costs no generality to
assume \( \psi \) and \( \phi \) are continuous and real-valued in \cref{defn:c_transform}.

\begin{example}[$c(\cdot, y)$ is a $c$-concave function]
	\label{example:square_distance_c-concave}
	For two compact sets $X,Y \subset M$, we fix a $y \in Y$ then
	$c(\cdot, y):=\frac{1}{2}d(\cdot,y)^2 \in \mathcal{I}^c (X,Y)$ for a fixed $y$ is a $c$-concave function.
	Because we can define a desired $\psi$ by setting $\psi (y) := 0$ and $\psi (z) := - \infty$ for $ z \neq y, z \in Y$.
\end{example}

% Let us also recall one of the basic lemmas from its proof,
% which illuminates the structure of the map \( T \).
Given two compact subsets \( X \) and \( Y \subset M \) with \( \phi \in \mathcal { I } ^ { c } ( X , Y ) \),
one sees every \( ( x , y ) \in X \times Y \) satisfy
\begin{equation}
	\label{equa:c-concave_conjugate}
	c ( x , y ) - \phi ( x ) - \phi ^ { c } ( y ) \geq 0
\end{equation}
with equality when \( \phi ( x ) = \inf _ { y ^ { \prime } \in Y } c \left( x , y ^ { \prime } \right) - \phi ^ { c } \left( y ^ { \prime } \right) = c ( x , y ) - \phi ^ { c } ( y ) . \)

The following lemma \cite[Lemma 3.2]{cordero2001riemannian} is fundamental in the sequel discussion,
detailed proofs can be found in \cite[Lemmas 2 and 7]{mccann2001polar}.
For any \( y \in M \), we denote by \( d _ { y } ( \cdot ) : = d ( \cdot , y ) \)
the distance function to \( y \).
\begin{lem}
	[Elementary properties of \( c \)-concave functions]
	\label{lem:minimizer_differentiable}
	Fix \( \mathcal{X} \subset \subset M \) open and \( Y \subset M \) compact,
	where $ \mathcal{X} \subset \subset M $ means that $\mathcal{X}$ is a pre-compact subset of $M$.
	For \( \phi \in \mathcal{I} ^ { c } ( \widebar { \mathcal{X} } , Y ) \), we define \( F ( x ) : = \)
	\( \exp _ { x } ( - \nabla \phi ( x ) ) \).
	\begin{enumerate}
		\item The function \( \phi \) is Lipschitz on \( \widebar { \mathcal{X} } \) and
		      hence differentiable almost everywhere on \( \mathcal{X} \) with respect to the volume measure on $M$.
		\item Fix any point \( x \in  \mathcal{X} \) where \( \phi \) is differentiable. Then \( y = F ( x ) \) if and
		      only if \( y \) minimizes \cref{equa:c-concave_conjugate} among \( y ^ { \prime } \in Y . \) In the latter case one has
		      \( \nabla \phi ( x ) = \nabla d _ { y } ^ { 2 } ( x ) / 2 \).
	\end{enumerate}
\end{lem}

As we mentioned in \Cref{example:square_distance_c-concave},
the squared distance function $c(\cdot, y):=\frac{1}{2}d(\cdot,y)^2=\frac{1}{2}d^2_y(\cdot)$
is a $c$-concave function and \Cref{lem:minimizer_differentiable} applies.
And it turns out that the two conclusions from
\Cref{lem:minimizer_differentiable} is quite natural from the perspective of cut locus.

\subsection{Reminder for cut locus}

For \( x \in M \), the \emph{cut locus} refers to the set \( \operatorname{cut}( x ) \subset M \) of all \( z \in M \) which
which do not belong to the relative interior of a minimizing geodesic going
through $x$.
% cannot be linked to \( x \) by an extendable minimizing geodesic.
The exponential map \( \exp _ { x } : T _ { x } M \rightarrow M \) is differentiable
at any tangent vector \( v \in T _ { x } M \) satisfying \( \exp _ { x } v \notin \operatorname{cut}( x )\),
and its differential \( \diff \left( \exp _ { x } \right) _ { v } \) gives a linear bijection between the tangent
spaces \( T _ { x } M \) and \( T _ { \exp _ { x } v} M\).
We mention that the cut locus $\operatorname{cut} (x)$ is a closed set with measure zero
with respect to the volume measure \cite[Lemma 3.96]{gallot2004riemannian}.

The relationship between distance function $d_y(\cdot) : = d(\cdot, y) $ and the
exponential map is summarized by the formula \( d _ { y } \left( \exp _ { y } v \right) = | v | \),
which holds for any \( v \) from the star-shaped domain around \( 0 \in T _ { y } M \)
which does not intersect \( \left( \exp _ { y } \right) ^ { - 1 } [ \operatorname{cut} ( y ) ]\).
This shows the exponential map generates the minimal geodesics through \( y \),
and that the function \( d _ { y } ^ { 2 } / 2 \) is smooth around any \( x \notin \operatorname{cut} ( y ) \).
Where \( d _ { y } ^ { 2 } / 2 \) is differentiable,
its gradient is related to the exponential map by the formula
\begin{equation}
	\label{equa:exponential_map_and_squared_distance_function}
	y = \exp _ { x } \left[ - \nabla d _ { y } ^ { 2 } ( x ) / 2 \right],
\end{equation}
which is a direct consequence of Gauss lemma \cite[Lemma 5.5.5]{petersen2016riemannian}.
And for \( x \notin \operatorname { cut } ( y ) \) its Hessian \( H = \operatorname{ Hess} _ { x } d _ { y } ^ { 2 } / 2 \) can be viewed either as a symmetric quadratic form on \( T _ { x } M \) or as a self-adjoint operator
\( H : T _ { x } M \rightarrow T _ { x } M \).
Note that \cref{equa:exponential_map_and_squared_distance_function} requires the existence of
a minimal geodesic linking \( x \) to \( y \),
and it is for this reason that completeness of the manifold is required.

In the sequel, it proves useful to characterize the cut locus \( \operatorname { cut } ( y ) \) as
the set of points where the distance function \( d _ { y } ^ { 2 } / 2 \) must fail to be smooth.
As mentioned above,
\( d _ { y } ^ { 2 } / 2 \) is as smooth as the manifold away from the cut locus of \( y \).
But \( \operatorname{cut} ( y ) \) consists of two kinds of points \cite[Scholium 3.78]{gallot2004riemannian}:
\begin{enumerate}
	\item those connected to \( y \) by multiple minimizing geodesics, and
	\item	those which are conjugate to \( y \) but do not fall into the first class.
\end{enumerate}
The point of the following proposition \cite[Proposition 2.5]{cordero2001riemannian}
is that differentiability of \( d _ { y } ^ { 2 } \) must fail --- at first order in the first case,
and at second order in the second case.
Moreover, the failure occurs with a definite sign:
the Hessian diverges to $-\infty$ while remaining bounded above, according to \Cref{lem:hessian_bound_distance_squared}.

\begin{prop}
	[Distances fail to be semi-convex at the cut locus]
	\label{prop:distance_cut_locus}
	At each \( x \in \operatorname { cut } ( y ) \), the square distance \( d _ { y } ^ { 2 } / 2 \) satisfies:
	\[ \inf _ { 0 < | v | < 1 } \frac { d_y^2 \left( \exp _ { x } v \right) + d_y^2 \left( \exp _ { x } - v \right)
		- 2 d_y^2 ( x ) } { | v | ^ { 2 } } = - \infty. \]
\end{prop}
