%! TEX root = ../barycenter.tex
\chapter{In the case of Riemannian manifold}

We continue to use notations in the proof of last \cref{thm:barycenter_finite_support_measure}.
There is a measurable function $B$ from $n$ points $x_i \in E$ to a barycenter of $\sum_{i=1}^{n} \lambda_i \delta_{x_i}$;
and we have shown that
\[f(\boldsymbol{x}) :=W_p(\sum_{i=1}^n \lambda_i \delta_{\mu_i}, E)^p =\min_x \sum_{i=1}^n \lambda_i d(x, x_i)^p\]
is continuous.
For the study in the case when $E$ is a complete manifold $M$,
we set $p = 2$ and apply some possible (non-)smooth analysis.
We firstly establish some fine properties of two functions $f$ and $B$.
% As an infimum involution, $f$ is locally Lipschitz;
% while $B$, not necessarily continuous, shares similar properties as optimal transference maps
% and we should talk about their differentiability only with respect to some reference measure.
As we shall see later from \cref{equa:formula_barycenter},
% both optimal transference map $T$ in \cref{thm:uniquness_monge_problem_manifold} and
barycenter map $B$
has the form $\exp( - \nabla h)$ for some $c$-concave
function $h$ that is differentiable almost everywhere.
% \section{Details for analysis on manifolds}
\section{\texorpdfstring{$c$}{c}-concave function}

Most content is this section is a copy-paste from \cite{cordero2001riemannian},
detailed proofs and reference are given there.
From now on, $M$ is always a complete Riemannian manifold.
% But $ \nabla h$ is not defined everywhere.
% And even for compact manifold $M$,
% $\exp( - \nabla h)$ as an optimal transference map could be discontinuous.
% A proper definition of the differential $\diff \exp(- \nabla h)$,
% of course only possible almost everywhere,
% is the main goal of this section.

% \subsection{Differentiate squared distance function}

For \( x \in M \), the \emph{cut locus} refers to the set \( \operatorname{cut}( x ) \subset M \) of all \( z \in M \) which
cannot be linked to \( x \) by an extendable minimizing geodesic.
The exponential map \( \exp _ { x } : T _ { x } M \rightarrow M \) is differentiable
at any tangent vector \( v \in T _ { x } M \) satisfying \( \exp _ { x } v \notin \operatorname{cut}( x )\),
and its differential \( \diff \left( \exp _ { x } \right) _ { v } \) gives a linear bijection between the tangent
spaces \( T _ { x } M \) and \( T _ { \exp _ { x } v} M\).

For any \( y \in M \) denote by \( d _ { y } ( \cdot ) : = d ( \cdot , y ) \)
the distance function to \( y \).
The relationship between this distance and the
exponential map is summarized by the formula \( d _ { y } \left( \exp _ { y } v \right) = | v | \),
which holds for any \( v \) from the star-shaped domain around \( 0 \in T _ { y } M \)
which does not intersect \( \left( \exp _ { y } \right) ^ { - 1 } [ \operatorname{cut} ( y ) ]\).
This shows the exponential map generates the minimal geodesics through \( y \),
and that the function \( d _ { y } ^ { 2 } / 2 \) is smooth around any \( x \notin \operatorname{cut} ( y ) \).
Where \( d _ { y } ^ { 2 } / 2 \) is differentiable,
its gradient is related to the exponential map by the formula,
\begin{equation}
	\label{equa:exponential_map_and_squared_distance_function}
	y = \exp _ { x } \left[ - \nabla d _ { y } ^ { 2 } ( x ) / 2 \right]
\end{equation}
and for \( x \notin \operatorname { cut } ( y ) \) its Hessian \( H = \operatorname{ Hess} _ { x } d _ { y } ^ { 2 } / 2 \) can be viewed either as a symmetric quadratic form on \( T _ { x } M \),
or --- more frequently --- as a self-adjoint operator
\( H : T _ { x } M \rightarrow T _ { x } M \).
Note that \cref{equa:exponential_map_and_squared_distance_function} requires the existence of
a minimal geodesic linking \( x \) to \( y \),
and it is for this reason that completeness of the manifold is required.


Both $f$ and $B$, and even optimal transference plan are related to so-called $c$-concave functions.

\begin{defn} [$c$-transforms and the subset \( \mathcal { I } ^ { c } ( X , Y ) \) of \( c \)-concave functions]
	Let \( X \) and \( Y \) be two compact subsets of \( M \).
	The set \( \mathcal{I} ^ { c } ( X , Y ) \) of \( c \)-concave functions (relative to \( X \) and \( Y \) ) is
	the set of functions \( \phi \) : \( X \rightarrow \mathbb { R } \cup \{ - \infty \} \) not identically \( - \infty \),
	for which there exists a function \( \psi : Y \rightarrow \mathbb { R } \cup \{ - \infty \} \) such that
	\begin{equation}
		\label{defn:c_transform}
		\phi ( x ) = \inf _ { y \in Y } c ( x , y ) - \psi ( y ) \quad \forall x \in X.
	\end{equation}
	We refer to \( \phi \) as the \( c \)-transform of \( \psi \) and abbreviate \cref{defn:c_transform}
	by writing \( \phi = \psi ^ { c } \).
	Similarly, given \( \phi \in \mathcal{I} ^ { c } ( X , Y ) \),
	we define its \( c \)-transform \( \phi ^ { c } \in \mathcal{I} ^ { c } ( Y , X ) \) by
	\begin{equation} 
					\label{equa:c_transform_of_c_conjugate}
	\phi ^ { c } ( y ) : = \inf _ { x \in X } c ( x , y ) - \phi ( x ) \quad \forall y \in Y.
	\end{equation}
\end{defn}

We hope no confusion results from the tacit dependence of
these transformations on the domain of the function being transformed.
For \( \phi \in \) \( \mathcal { I } ^ { c } ( X , Y ) \),
it follows easily from \cref{equa:c_transform_of_c_conjugate} as in Rachev and RÃ¼schendorf
(\cite[Section 3.3]{Rachev1998}) that
\[ \phi ( x ) = \inf _ { y \in Y } c ( x , y ) - \phi ^ { c } ( y ) \quad \forall x \in X \]
which we abbreviate by writing \( \phi ^ { c c } = \phi \), suppressing the domains of definition once more.
As in \cite{mccann2001polar}, Lipschitz continuity of \( \phi ^ { c } \) follows merely from
compactness of \( X \) and the locally Lipschitzian character of \( c ( x , y ) \),
whether or not \( \phi : X \rightarrow \mathbb { R } \cup \{ - \infty \} \) is continuous.
Thus it costs no generality to
assume \( \psi \) and \( \phi \) are continuous and real-valued in \cref{defn:c_transform}.

Note that function $c(x,y)$ for fixed $x$ is a $c$-concave function.

\begin{thm}[Optimal transportation on manifolds]
	\label{thm:optimal_transport_manifold}
	Let \( M \) be a complete Riemannian manifold.
	Fix two Borel probability measures \( \mu \ll \) vol and \( v \) on \( M \),
	and two compact subsets \( X \) and \( Y \subset M \) containing the support of \( \mu \) and \( v \),
	respectively.
	Then there exists \( \phi \in \mathcal { I } ^ { c } ( X , Y ) \) such that the map
	\begin{equation}
		\label{equa:transform_map}
		T ( x ) : = \exp _ { x } ( - \nabla \phi ( x ) )
	\end{equation}
	pushes \( \mu \) forward to \( v \).
	This map is uniquely characterized among all maps pushing \( \mu \) forward \( v \) by formula \cref{equa:transform_map} with \( \phi \in \mathcal{I} ^ { c } ( X , Y )\).

	Furthermore, $T$ is the optimal transference map asserted in \cref{thm:uniquness_monge_problem_manifold}.
\end{thm}

Let us also recall one of the basic lemmas from its proof,
which illuminates the structure of the map \( T \).
Given two compact subsets \( X \) and \( Y \subset M \) with \( \phi \in \mathcal { I } ^ { c } ( X , Y ) \),
one sees every \( ( x , y ) \in X \times Y \) satisfy
\begin{equation}
	\label{equa:c-concave_conjugate}
	c ( x , y ) - \phi ( x ) - \phi ^ { c } ( y ) \geq 0
\end{equation}
with equality when \( \phi ( x ) = \inf _ { y ^ { \prime } \in Y } c \left( x , y ^ { \prime } \right) - \phi ^ { c } \left( y ^ { \prime } \right) = c ( x , y ) - \phi ^ { c } ( y ) . \)

\begin{lem}
	[Elementary properties of \( c \)-concave functions]
	\label{lem:minimizer_differentiable}
	Fix \( \mathcal{X} \subset \subset M \) open and \( Y \subset M \) compact.
	For \( \phi \in \mathcal{I} ^ { c } ( \bar { \mathcal{X} } , Y ) \) define \( F ( x ) : = \)
	\( \exp _ { x } ( - \nabla \phi ( x ) ) \).
	\begin{enumerate}
		\item The function \( \phi \) is Lipschitz on \( \bar { \mathcal{X} } \) and hence differentiable almost every-
		      where on \( \mathcal{X} \).
		\item Fix any point \( x \in X \) where \( \phi \) is differentiable. Then \( y = F ( x ) \) if and
		      only if \( y \) minimizes \cref{equa:c-concave_conjugate} among \( y ^ { \prime } \in Y . \) In the latter case one has
		      \( \nabla \phi ( x ) = \nabla d _ { y } ^ { 2 } ( x ) / 2 \).
	\end{enumerate}
\end{lem}

Following definitions generalize the concept gradient and
always exist for $c$-concave functions in contrast to the usual gradient.
We shall use them to give a proper definition of Hessian when gradient of
function is not defined everywhere.

\begin{defn}
	[$c$-super-differential \( \partial ^ { c } \phi \)]
	Let \( X , Y \) be two compact sets of M. For \( \phi \in \mathcal { I } ^ { c } ( X , Y ) \)
	and \( x \in X \), the \( c \)-super-differential of \( \phi \) at \( x \) is the non-empty set
	\begin{align}
		\partial ^ { c } \phi ( x ) & : = \left\{ y \in Y \mid \phi ( x ) + \phi ^ { c } ( y ) = c ( x , y ) \right\}                   \\
		                            & = \{ y \in Y \mid \phi ( z ) \leq \phi ( x ) + c ( z , y ) - c ( x , y ) \quad \forall z \in X \}
		\label{equa:c-super-differential}
	\end{align}
\end{defn}

\begin{example} [Multivalued extension]
	\label{example:minimizer_differentiable}
	If \( \phi \in \mathcal { I } ^ { c } ( \bar {\mathcal{X} } , Y ) \) is differentiable at
	\( x \in \mathcal { X } \subset \subset M \),
	then \( \partial ^ { c } \phi ( x ) = \{ F ( x ) \} = \left\{ \exp _ { x } ( - \nabla \phi ( x ) ) \right\} \) according to \cref{lem:minimizer_differentiable}.
\end{example}

\begin{defn}
	A function \( \phi : \Omega \rightarrow \mathbb { R } \) defined on an open subset \( \Omega \) of \( M \)
	is said to be super-differentiable at \( x \in \Omega \) with super-gradient \( v \in T _ { x } M \) if for
	\( u \rightarrow 0 \in T _ { x } M \),
	\begin{equation}
		\label{equa:super-differential}
		\phi \left( \exp _ { x } u \right) \leq \phi ( x ) + \langle v , u \rangle + o ( | u | )
	\end{equation}
	The super-differential of \( \phi \) at \( x \) refers to the convex set \( \partial \phi ( x ) \subset T _ { x } M \) of all
	super-gradients at \( x \).
\end{defn}

One can easily check that a function is differentiable if it is both
super-differentiable and sub-differentiable.
A typical example of a function which admits super-gradients everywhere
is the square distance \( d _ { y } ^ { 2 } / 2 \) to \( y \in M \).
Indeed, if \( \gamma \) is a minimal geodesic
joining \( x = \gamma ( 0 ) \) to \( y = \gamma ( 1 ) \),
then \( - \dot { \gamma } ( 0 ) \in \partial \left( d _ { y } ^ { 2 } / 2 \right) ( x ) \)  as shown in \cite[Proposition 7]{mccann2001polar}.

\begin{lem}[$c$-super-gradients imply super-gradients]
	\label{lem:c-super-gradients_imply_super-gradients}
	Fix \( \mathcal { X } \subset \subset M \) open,
	\( Y \subset M \) compact, and \( \phi \in \mathcal { I } ^ { c } ( \bar { \mathcal{X} } , Y ) \).
	Let \( ( x , y ) \in \mathcal { X } \times Y \) and \( v \in T _ { x } M \) satisfy
	\( | v | = d ( x , y ) \) and \( \exp _ { x } ( - v ) = y\).
	If \( y \in \partial ^ { c } \phi ( x ) \) then
	\( v \in \partial \phi ( x ) \).
\end{lem}

